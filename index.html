<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Painel GLPI + Notícias Tech</title>
<style>
body, html {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: 'Segoe UI', Roboto, Arial, sans-serif;
  overflow: hidden;
  background: #000;
  color: #fff;
}

/* Iframe dos dashboards */
#iframeDisplay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  border: none;
  display: none;
  z-index: 0;
}

/* Container da notícia */
.noticia {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

/* Fundo com efeito parallax */
.fundo {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  opacity: 0;
  transition: opacity 1.5s ease-in-out, transform 20s ease-in-out;
  z-index: 0;
}

.fundo.ativo {
  opacity: 1;
  transform: scale(1.05);
}

/* Legenda com gradiente */
.conteudo {
  position: absolute;
  top: 0;
  left: 0;
  width: 25%;
  height: 100%;
  padding: 30px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  backdrop-filter: blur(10px);
  background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(0,0,0,0));
  color: #fff;
  z-index: 1;
}

.titulo {
  font-size: 36px;
  font-weight: bold;
  margin-bottom: 15px;
  text-shadow: 2px 2px 15px rgba(0,0,0,0.8);
}

.fonte {
  font-size: 20px;
  text-shadow: 1px 1px 8px rgba(0,0,0,0.7);
}
</style>
</head>
<body>

<iframe id="iframeDisplay"></iframe>

<div id="noticia" class="noticia">
  <div class="fundo"></div>
  <div class="conteudo">
    <div class="titulo"></div>
    <div class="fonte"></div>
  </div>
</div>

<script>
const tempoNoticia = 15000;
const tempoSite = 30000;
const qtdNoticiasAntesSites = 6;

const iframe = document.getElementById("iframeDisplay");
const divNoticia = document.getElementById("noticia");
const titulo = divNoticia.querySelector(".titulo");
const fonte = divNoticia.querySelector(".fonte");
const fundo = divNoticia.querySelector(".fundo");

const sites = [
  "http://192.168.1.212/plugins/dashboard/front/metrics/index.php",
  "http://192.168.1.250:3000/d/adj0e1rfldfcwa/servidores-corpal?orgId=2&refresh=5s&kiosk",
  "http://192.168.1.250:3000/d/edj7lqmj4vyf4c/servidores-corpal-2?orgId=2&refresh=5s&kiosk"
];

let noticias = [];

function esperar(ms){ return new Promise(res => setTimeout(res, ms)); }

async function carregarRSS(url, fonteNome){
  try{
    const resp = await fetch(`/rss?url=${encodeURIComponent(url)}`);
    const texto = await resp.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(texto, "text/xml");
    const items = Array.from(xml.querySelectorAll("item, entry"));

    return items.map(item=>{
      let image = "";
      const enc = item.querySelector("enclosure");
      if(enc) image = enc.getAttribute("url");

      if(!image){
        const media = item.getElementsByTagNameNS("http://search.yahoo.com/mrss/", "content")[0]
                    || item.getElementsByTagNameNS("http://search.yahoo.com/mrss/", "thumbnail")[0];
        if(media) image = media.getAttribute("url");
      }

      if(!image){
        const desc = item.querySelector("description")?.innerHTML || item.querySelector("content")?.innerHTML || "";
        const imgMatch = desc.match(/<img[^>]+(?:src|data-src|srcset)=["'](.*?)["']/i);
        if(imgMatch) image = imgMatch[1];
      }

      let pubDate = item.querySelector("pubDate")?.textContent || item.querySelector("updated")?.textContent || "";
      let timestamp = pubDate ? new Date(pubDate).getTime() : Date.now();

      return { title: item.querySelector("title")?.textContent||"", image, source:{name:fonteNome}, timestamp };
    });
  } catch(e){ console.error("Erro RSS", e); return []; }
}

function filtrarNoticias(noticias){
  const ignorar = ["celular","smartphone","notebook","computador","jogo","games","filme","cinema","tv","entretenimento","promoção","Netflix"];
  return noticias.filter(n=>{
    const t = (n.title||"").toLowerCase();
    return !ignorar.some(p=>t.includes(p));
  });
}

async function carregarNoticias(){
  const canaltech = filtrarNoticias(await carregarRSS("https://canaltech.com.br/rss/", "Canaltech"));
  const g1tech = filtrarNoticias(await carregarRSS("https://g1.globo.com/rss/g1/tecnologia/", "G1 Tecnologia"));
  const g1mundo = filtrarNoticias(await carregarRSS("https://g1.globo.com/rss/g1/mundo/", "G1 Mundo"));

  noticias = [];
  while(canaltech.length || g1tech.length || g1mundo.length){
    if(canaltech.length) noticias.push(canaltech.shift());
    if(g1tech.length) noticias.push(g1tech.shift());
    if(g1mundo.length) noticias.push(g1mundo.shift());
  }
}

function mostrarNoticia(n){
  iframe.style.display = "none";
  divNoticia.style.display = "block";

  fundo.classList.remove("ativo");
  void fundo.offsetWidth;
  fundo.style.backgroundImage = n.image ? `url(${n.image})` : "";
  fundo.classList.add("ativo");

  titulo.innerText = n.title;
  fonte.innerText = n.source?.name || "Fonte desconhecida";
}

function mostrarSite(url){
  divNoticia.style.display = "none";
  iframe.style.display = "block";
  iframe.src = url + "?rand=" + Math.random();
}

async function ciclo(){
  while(true){
    await carregarNoticias();
    if(noticias.length===0){
      for(let s of sites){
        mostrarSite(s);
        await esperar(tempoSite);
      }
      continue;
    }

    let count = 0;
    for(let n of noticias){
      mostrarNoticia(n);
      await esperar(tempoNoticia);
      count++;
      if(count % qtdNoticiasAntesSites === 0){
        for(let s of sites){
          mostrarSite(s);
          await esperar(tempoSite);
        }
      }
    }
  }
}

ciclo();
</script>

</body>
</html>
